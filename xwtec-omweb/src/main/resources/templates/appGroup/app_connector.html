<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/static :: common_head(~{::title},~{::link},~{::script})">

    <title>欣网管理后台</title>
    <link rel="stylesheet"
          th:href="${application.webStaticUrl}+'/static/admin-lte/plugins/jsplumb/css/jsPlumbToolkit-defaults.css'">

    <link rel="stylesheet" th:href="${application.webStaticUrl}+'/static/admin-lte/plugins/jsplumb/css/demo.css'">

    <!-- select2样式 -->
    <script th:src="${application.webStaticUrl}+'/static/admin-lte/plugins/jsplumb/jsplumb.min.js'"></script>

    <script type="text/javascript">

        jsPlumb.ready(function () {

            // setup some defaults for jsPlumb.
            var instance = jsPlumb.getInstance({
                Endpoint: ["Dot", {radius: 2}],
                Connector: "Flowchart",
                HoverPaintStyle: {stroke: "#1e8151", strokeWidth: 2},
                ConnectionOverlays: [
                    ["Arrow", {
                        location: 1,
                        id: "arrow",
                        length: 14,
                        foldback: 0.8
                    }],
                    ["Label", {id: "label", cssClass: "aLabel"}]
                ],
                Container: "canvas"
            });

            instance.registerConnectionType("basic", {anchor: "Continuous", connector: "Flowchart"});

            window.jsp = instance;

            var canvas = document.getElementById("canvas");


            $.post(
                "[[${webUrl}]]/omweb/appGroup/getGroupApps",
                {groupId: '[[${groupId}]]'},
                function (callback) {
                    if (callback.success) {
                        console.debug(callback.data);
                        if (callback.data.locations) {
                            locations = callback.data.locations;
                            //加载位置
                            $.each(callback.data.locations, function (i, v) {
                                var interval = 10;
                                var nodeWidth = $(".w").outerWidth() || 10;
                                if (this.hAxis == 0 && this.vAxis == 0) {
                                    newAppNode(this.appId, this.appName, (i * (nodeWidth)) + (i == 0 ? interval : i * interval + interval), interval);
                                } else {
                                    newAppNode(this.appId, this.appName, this.hAxis, this.vAxis);
                                }
                            });



                        }
                        if(callback.data.connections){
                            connections = connections;
                            //加载连线
                            $.each(callback.data.connections, function (i, v) {
                                instance.connect({source: v.source, target: v.target, type: "basic"});
                            });

                        }

                    } else {
                        $.notify.error(callback.message)
                    }
                });


            var windows = jsPlumb.getSelector(".statemachine-demo .w");

            // bind a click listener to each connection; the connection is deleted. you could of course
            // just do this: jsPlumb.bind("click", jsPlumb.detach), but I wanted to make it clear what was
            // happening.
            instance.bind("click", function (c) {
                instance.detach(c);
            });

            // bind a connection listener. note that the parameter passed to this function contains more than
            // just the new connection - see the documentation for a full list of what is included in 'info'.
            // this listener sets the connection's internal
            // id as the label overlay's text.
            instance.bind("connection", function (info) {

                if (info.connection.sourceId == info.connection.targetId) {
                    instance.detach(info);
                    //alert("不能连接自己！");
                }

                $.each(instance.getEndpoints(info.source), function (i, el) {
                    if (info.connection != el.connections[0] &&
                        (el.connections[0].targetId == info.targetId)) {
                        instance.detach(info);
                        //alert("不能重复连接！");
                        return false;
                    }
                    console.log(el);
                });
                //window.onConnectionChange && window.onConnectionChange();
                //info.connection.getOverlay("label").setLabel(info.connection.id);
            });
//connectionMoved
            instance.bind("connectionDetached", function (conn, originalEvent) {
                //window.onConnectionChange && window.onConnectionChange();
            });

            var connections = [], locations = [];

            window.onConnectionChange = function () {
                connections = [], locations = [];
                var conns = instance.getAllConnections();
                $.each(conns, function (i, el) {
                    var source = $(el.source);
                    var target = $(el.target);

                    var temp = $.grep(locations, function (value) {
                        return value == source.attr("id");
                    });
                    if (temp.length == 0) {
                        locations.push({
                                appId: source.attr("id"),
                                groupId: '[[${groupId}]]',
                                hAxis: source.position().left,
                                vAxis: source.position().top
                            }
                        );
                    }
                    temp = $.grep(locations, function (value) {
                        return value == target.attr("id");
                    });
                    if (temp.length == 0) {
                        locations.push({
                            appId: target.attr("id"),
                            groupId: '[[${groupId}]]',
                            hAxis: target.position().left,
                            vAxis: target.position().top
                        });
                    }
                    connections.push({
                        source: source.attr("id"),
                        target: target.attr("id"),
                        groupId: '[[${groupId}]]'
                    });

                });

                //console.log(JSON.stringify(connections))
                //console.log(JSON.stringify(locations))

            };


            $(".content-wrapper").on("click",".btnSubmit",function () {
                window.onConnectionChange && window.onConnectionChange();
                $.ajax({
                    type: "post",
                    url: '[[${webUrl}]]/omweb/appGroup/saveGroupAppsCanvas' ,
                    dataType:"json",
                    contentType:"application/json;charset=utf-8",
                    data: JSON.stringify({
                        connections:connections,
                        locations:locations
                    }),
                    success: function (callback) {
                        if (callback.success) {
                            $.notify.success(callback.message, "", function () {
                                //location.href = '[[${webUrl}]]/appGroup/index';
                            });

                        } else {
                            $.notify.error(callback.message)
                        }
                    }
                });
            });


            // bind a double click listener to "canvas"; add new node when this occurs.
//            jsPlumb.on(canvas, "dblclick", function (e) {
//                newNode(e.offsetX, e.offsetY);
//            });


            //
            // initialise element as connection targets and source.
            //
            var initNode = function (el) {

                // initialise draggable elements.
                instance.draggable(el);

                instance.makeSource(el, {
                    filter: ".ep",
                    anchor: "Continuous",
                    connectorStyle: {stroke: "#5c96bc", strokeWidth: 2, outlineStroke: "transparent", outlineWidth: 4},
                    connectionType: "basic",
                    extract: {
                        "action": "the-action"
                    },
                    maxConnections: -1
                });

                instance.makeTarget(el, {
                    dropOptions: {hoverClass: "dragHover"},
                    anchor: "Continuous",
                    allowLoopback: true,
                    maxConnections: -1
                });

                // this is not part of the core demo functionality; it is a means for the Toolkit edition's wrapped
                // version of this demo to find out about new nodes being added.
                //
                instance.fire("jsPlumbDemoNodeAdded", el);
            };


            var newAppNode = function (appId, appName, x, y) {
                var d = document.createElement("div");
                d.className = "w";
                d.id = appId;
                d.innerHTML = "<img src='[[${application.webStaticUrl}]]/static/style/images/icon-cloud.png'><div>" + appName + "</div>" + "<div class=\"ep\"></div>";
                d.style.left = x + "px";
                d.style.top = y + "px";
                instance.getContainer().appendChild(d);
                initNode(d);
                return d;
            };

            var newNode = function (x, y) {
                var d = document.createElement("div");
                var id = jsPlumbUtil.uuid();
                d.className = "w";
                d.id = id;
                d.innerHTML = id.substring(0, 7) + "<div class=\"ep\"></div>";
                d.style.left = x + "px";
                d.style.top = y + "px";
                instance.getContainer().appendChild(d);
                initNode(d);
                return d;
            };

            // suspend drawing and initialise.
            instance.batch(function () {
                for (var i = 0; i < windows.length; i++) {
                    initNode(windows[i], true);
                }
                // and finally, make a few connections
                instance.connect({source: "opened", target: "phone1", type: "basic"});
                instance.connect({source: "phone1", target: "phone1", type: "basic"});
                instance.connect({source: "phone1", target: "inperson", type: "basic"});

                instance.connect({
                    source: "phone2",
                    target: "rejected",
                    type: "basic"
                });
            });

            jsPlumb.fire("jsPlumbDemoLoaded", instance);

        });


    </script>

</head>
<body th:replace="fragments/content :: page(~{ :: .content-wrapper })">

<div class="content-wrapper">
    <section class="content-header">
        <h1>
            应用系统管理中心
        </h1>
        <ol class="breadcrumb">
            <li><a th:href="${homeUrl}"><i class="fa fa-home"></i> 首页</a></li>
            <li><a th:href="${webUrl} + '/omweb/appGroup/index'"><i class="fa fa-users"></i> 应用系统管理</a></li>
            <li class="active">应用系统详情维护</li>
        </ol>
    </section>

    <section class="content">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">应用系统详情维护</h3>
                    </div>
                    <!-- /.box-header -->
                    <!-- form start -->

                    <div class="box-body">
                        <!-- demo -->
                        <div class="jtk-demo-canvas canvas-wide statemachine-demo jtk-surface jtk-surface-nopan clear"
                             id="canvas">

                        </div>
                        <!-- /demo -->
                    </div>
                    <!-- /.box-body -->

                    <div class="box-footer">
                        <button type="button" class="btn btn-primary btnSubmit">提交</button>
                    </div>

                </div>
                <!-- /.box -->
            </div>
        </div>
    </section>
</div>
</body>
</html>